<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mingala — Chat App v3.0 (Fixed)</title>

  <!-- Fonts / libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

  <style>
    /* ---------- Basic theme & layout (improved) ---------- */
    :root{
      --bg:#0f1724; --panel: rgba(12,18,30,0.6); --muted:#9ca3af; --text:#ecf0f3;
      --accent:#10b981; --accent-2:#059669; --glass: rgba(255,255,255,0.06);
      --radius:12px; --transition:200ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{background:linear-gradient(180deg,#071024 0%, #0f1724 100%); color:var(--text); overflow:hidden;}

    /* container */
    .app { height:100vh; display:flex; gap:1rem; padding:1rem; align-items:stretch; }
    aside.sidebar{width:300px; background:var(--panel); border-radius:var(--radius); padding:1rem; display:flex; flex-direction:column; gap:0.75rem; border:1px solid var(--glass); }
    main.area{flex:1; display:flex; flex-direction:column; background:var(--panel); border-radius:var(--radius); border:1px solid var(--glass); overflow:hidden;}

    header.top{display:flex; align-items:center; justify-content:space-between; padding:0.75rem 1rem; background:transparent}
    .brand{display:flex; align-items:center; gap:0.75rem}
    .logo-circle{width:36px; height:36px; border-radius:50%; background:linear-gradient(45deg,var(--accent),var(--accent-2)); display:grid; place-items:center; font-weight:700; color:#fff}

    /* sidebar controls */
    .btn{background:transparent; border:0; padding:8px 12px; border-radius:10px; color:var(--text); cursor:pointer}
    .btn.primary{background:var(--accent); color:#fff}
    .btn.secondary{background:rgba(255,255,255,0.04); color:var(--text)}
    .new-chat{display:block; width:100%; margin-bottom:6px; font-weight:600}

    .chat-list{overflow:auto; display:flex; flex-direction:column; gap:6px; padding-bottom:8px}
    .chat-item{padding:10px 12px; border-radius:10px; cursor:pointer; color:var(--muted); transition:all var(--transition); white-space:nowrap; text-overflow:ellipsis; overflow:hidden;}
    .chat-item:hover{background:rgba(255,255,255,0.03); color:var(--text)}
    .chat-item.active{background:var(--accent); color:#fff}

    /* chat area */
    .chat-header{padding:12px 16px; border-bottom:1px solid var(--glass); display:flex; align-items:center; justify-content:space-between}
    .chat-window{flex:1; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:12px}
    .welcome{display:flex;flex-direction:column; align-items:center; justify-content:center; height:100%; color:var(--muted)}
    .welcome h2{color:var(--text); margin:12px 0 6px; font-size:1.4rem}
    .message{max-width:80%; padding:10px 14px; border-radius:12px; line-height:1.5; word-break:break-word; box-shadow:0 6px 20px rgba(0,0,0,0.25)}
    .message.user{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff; align-self:flex-end; border-bottom-right-radius:6px;}
    .message.assistant{background:rgba(255,255,255,0.03); color:var(--text); align-self:flex-start; border-bottom-left-radius:6px;}
    pre{background:rgba(0,0,0,0.4); padding:10px; border-radius:8px; overflow:auto}

    .input-bar{display:flex; gap:10px; padding:12px; border-top:1px solid var(--glass)}
    textarea#message-input{flex:1; min-height:46px; max-height:200px; padding:10px 12px; border-radius:12px; resize:none; background:transparent; color:var(--text); border:1px solid var(--glass)}
    button#send-button{width:56px; height:46px; border-radius:12px; background:var(--accent); border:0; color:white; cursor:pointer}
    button#send-button[disabled]{background:rgba(255,255,255,0.03); cursor:not-allowed; color:var(--muted)}

    /* small screens */
    @media (max-width: 880px){
      aside.sidebar{display:none}
      .app{padding:0}
    }

    /* login overlay */
    #login-overlay{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50}
    .login-card{width:420px; max-width:92%; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:28px; border-radius:14px; border:1px solid var(--glass); text-align:center}
    .login-card h2{margin:10px 0 4px}
    .login-card p{color:var(--muted); margin-bottom:16px}

    /* small helpers */
    .muted{color:var(--muted); font-size:0.95rem}
    .mini{font-size:0.85rem; color:var(--muted)}
  </style>
</head>

<body>
  <!-- LOGIN / GUEST OVERLAY -->
  <div id="login-overlay">
    <div class="login-card">
      <div style="display:flex; justify-content:center;">
        <div class="logo-circle">M</div>
      </div>
      <h2>Welcome to Mingala</h2>
      <p class="muted">Your personal AI chat. Continue as guest or sign in with Google.</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
        <button id="btn-google-login" class="btn primary">Sign in with Google</button>
        <button id="btn-guest-login" class="btn secondary">Continue as Guest</button>
      </div>
      <p class="mini" style="margin-top:12px">Guest mode stores a temporary id in your browser (localStorage).</p>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="app" style="display:none" id="app-root">
    <aside class="sidebar">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="logo-circle">M</div>
          <div>
            <div style="font-weight:700">Mingala Chat</div>
            <div class="mini">AI assistant</div>
          </div>
        </div>
        <div>
          <button id="btn-theme" class="btn">Theme</button>
        </div>
      </div>

      <div style="margin-top:8px;">
        <button id="btn-new-chat" class="btn primary new-chat">+ New Chat</button>
      </div>

      <div class="chat-list" id="chat-list" role="list" aria-label="Chats"></div>

      <div style="margin-top:auto; display:flex; gap:8px; align-items:center;">
        <div id="user-info" style="display:flex; gap:8px; align-items:center;">
          <div style="width:36px;height:36px;border-radius:999px;background:rgba(255,255,255,0.06); display:grid; place-items:center;" id="user-avatar">G</div>
          <div>
            <div id="user-name" style="font-size:0.95rem">Guest</div>
            <div class="mini" id="user-id" style="max-width:160px; overflow:hidden; text-overflow:ellipsis;"></div>
          </div>
        </div>
        <div style="margin-left:auto">
          <button id="btn-logout" class="btn">Logout</button>
        </div>
      </div>
    </aside>

    <main class="area">
      <div class="chat-header">
        <div id="chat-title">Welcome</div>
        <div class="mini muted" id="chat-meta">Mingala v3.0</div>
      </div>

      <div class="chat-window" id="chat-window">
        <div class="welcome" id="chat-starter">
          <div style="width:96px;height:96px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent-2)); display:grid; place-items:center; font-weight:700; font-size:28px; color:white">M</div>
          <h2>How can I help you today?</h2>
          <p class="muted">Start a new chat or choose one from the left.</p>
        </div>
      </div>

      <div class="input-bar">
        <textarea id="message-input" placeholder="Type a message..." rows="1" disabled></textarea>
        <button id="send-button" disabled aria-label="Send">Send</button>
      </div>
    </main>
  </div>

  <script>
    /*****************************************************************************
     * Mingala Chat - Single file app (frontend)
     * Replace SUPABASE_URL and SUPABASE_ANON_KEY with your own project values.
     *
     * Expected DB schema:
     *  - chats(id uuid PK, user_id text, title text, created_at timestamptz)
     *  - messages(id uuid PK, chat_id uuid FK, role text ('user'|'assistant'), content text, created_at)
     *
     * Make sure RLS/policies allow anonymous read/write while testing.
     *****************************************************************************/

    // --------- CONFIG ----------
    const SUPABASE_URL = 'https://REPLACE_WITH_YOUR_PROJECT.supabase.co'; // <-- put your supabase url
    const SUPABASE_ANON_KEY = 'REPLACE_WITH_YOUR_ANON_KEY';               // <-- put your anon key

    // create client
    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // UI refs
    const loginOverlay = document.getElementById('login-overlay');
    const appRoot = document.getElementById('app-root');
    const btnGoogleLogin = document.getElementById('btn-google-login');
    const btnGuestLogin = document.getElementById('btn-guest-login');
    const btnNewChat = document.getElementById('btn-new-chat');
    const btnLogout = document.getElementById('btn-logout');
    const btnTheme = document.getElementById('btn-theme');

    const chatListEl = document.getElementById('chat-list');
    const chatWindow = document.getElementById('chat-window');
    const chatStarter = document.getElementById('chat-starter');
    const chatTitle = document.getElementById('chat-title');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    const userNameEl = document.getElementById('user-name');
    const userIdEl = document.getElementById('user-id');
    const userAvatar = document.getElementById('user-avatar');

    // state
    let currentUser = null;           // { id: string, name: string, is_anonymous: bool }
    let currentChatId = null;
    let messageSubscription = null;
    let renderedMessageIds = new Set();

    // ---------- Helpers ----------
    function showLogin() {
      loginOverlay.style.display = 'flex';
      appRoot.style.display = 'none';
    }
    function showApp() {
      loginOverlay.style.display = 'none';
      appRoot.style.display = 'flex';
    }
    function formatShortId(id){
      if(!id) return '';
      return id.length > 12 ? id.slice(0,8)+'…'+id.slice(-4) : id;
    }

    // render a single message object (role, content, id optional)
    function renderMessageRow(msg){
      // avoid duplicates
      if(msg?.id && renderedMessageIds.has(msg.id)) return;
      if(msg?.id) renderedMessageIds.add(msg.id);

      const role = msg.role || msg.sender_role || (msg.sender_id === currentUser?.id ? 'user' : 'assistant');
      const content = msg.content ?? msg.text ?? '';

      const row = document.createElement('div');
      row.className = 'message ' + (role === 'user' ? 'user' : 'assistant');
      // parse markdown and highlight code blocks
      row.innerHTML = marked.parse(content || '');
      row.querySelectorAll('pre code').forEach((block)=>hljs.highlightElement(block));
      chatWindow.appendChild(row);
      // scroll
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function clearChatWindow(){
      // keep starter visible if no chat
      chatWindow.innerHTML = '';
    }

    // ---------- Auth (Google + Guest support) ----------
    async function initAuth(){
      // check for existing supabase session (Google)
      try{
        const { data: { session } } = await supabase.auth.getSession();
        if(session?.user){
          // logged in with google
          currentUser = { id: session.user.id, name: session.user.user_metadata?.full_name || session.user.email, is_anonymous:false };
        } else {
          // check guest in localStorage
          const guestId = localStorage.getItem('mingala_guest_id');
          if(guestId){
            currentUser = { id: guestId, name: 'Guest', is_anonymous:true };
          }
        }
      } catch(e){
        console.error('Auth check error', e);
      }

      if(currentUser){
        applyUserToUI();
        await loadChatList();
        showApp();
      } else {
        showLogin();
      }
    }

    function applyUserToUI(){
      userNameEl.textContent = currentUser.name || 'Guest';
      userIdEl.textContent = formatShortId(currentUser.id);
      userAvatar.textContent = (currentUser.name || 'G')[0].toUpperCase();
    }

    // Google sign-in (redirect)
    btnGoogleLogin.addEventListener('click', async ()=>{
      await supabase.auth.signInWithOAuth({ provider: 'google' });
    });

    // Guest sign-in
    btnGuestLogin.addEventListener('click', ()=>{
      const guestId = 'guest_' + Math.random().toString(36).slice(2,10);
      localStorage.setItem('mingala_guest_id', guestId);
      currentUser = { id: guestId, name: 'Guest', is_anonymous:true };
      applyUserToUI();
      loadChatList();
      showApp();
    });

    // Logout (clears guest + supabase session)
    btnLogout.addEventListener('click', async ()=>{
      // clear local guest
      localStorage.removeItem('mingala_guest_id');
      currentUser = null;
      // sign out supabase (if logged)
      try { await supabase.auth.signOut(); } catch(e){/*ignore*/ }
      // teardown
      if(messageSubscription) messageSubscription.unsubscribe();
      renderedMessageIds.clear();
      clearChatWindow();
      showLogin();
    });

    // listen for supabase auth changes (if user signs in via redirect)
    supabase.auth.onAuthStateChange((event, session) => {
      // when Google sign-in completes, reload state
      if(session?.user){
        currentUser = { id: session.user.id, name: session.user.user_metadata?.full_name || session.user.email, is_anonymous:false };
        applyUserToUI();
        loadChatList();
        showApp();
      }
    });

    // ---------- Chats & Messages ----------
    async function loadChatList(){
      chatListEl.innerHTML = '';
      try{
        const { data, error } = await supabase.from('chats').select('*').order('created_at', { ascending:false });
        if(error){ console.error('loadChatList error', error); return; }
        if(!data || !data.length){
          // none yet - show nothing and keep starter
          chatTitle.textContent = 'Welcome';
          chatStarter.style.display = 'flex';
          messageInput.disabled = true;
          sendButton.disabled = true;
          return;
        }
        data.forEach(c=>{
          const el = document.createElement('div');
          el.className = 'chat-item';
          el.textContent = c.title || 'New Chat';
          el.dataset.id = c.id;
          el.onclick = ()=> openChat(c.id, c.title);
          if(c.id === currentChatId) el.classList.add('active');
          chatListEl.appendChild(el);
        });
        // if no currentChatId, open the first chat
        if(!currentChatId && data[0]) openChat(data[0].id, data[0].title);
      } catch(e){
        console.error(e);
      }
    }

    async function createNewChat(initialTitle = 'New Chat'){
      try{
        const { data, error } = await supabase.from('chats').insert([{ user_id: currentUser.id, title: initialTitle }]).select().single();
        if(error){ console.error('createNewChat error', error); return; }
        await loadChatList();
        openChat(data.id, data.title);
        return data;
      } catch(e){
        console.error(e);
      }
    }

    async function openChat(chatId, title = 'Chat'){
      if(messageSubscription) {
        try { messageSubscription.unsubscribe(); } catch(e){/*ignore*/ }
        messageSubscription = null;
      }
      currentChatId = chatId;
      chatTitle.textContent = title || 'Chat';
      chatStarter.style.display = 'none';
      messageInput.disabled = false;
      sendButton.disabled = false;
      renderedMessageIds.clear();
      clearChatWindow();
      await loadMessages(chatId);
      subscribeToMessages(chatId);
      // mark active item
      document.querySelectorAll('.chat-item').forEach(el=>el.classList.toggle('active', el.dataset.id === chatId));
    }

    async function loadMessages(chatId){
      try{
        const { data, error } = await supabase.from('messages').select('*').eq('chat_id', chatId).order('created_at', { ascending:true });
        if(error){ console.error('loadMessages error', error); return; }
        if(!data || !data.length){
          // no messages
          return;
        }
        data.forEach(m=>renderMessageRow(m));
      } catch(e){
        console.error(e);
      }
    }

    // subscribe to new messages for chat
    function subscribeToMessages(chatId){
      if(!chatId) return;
      // create channel
      messageSubscription = supabase.channel('public:messages')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, (payload)=>{
          const newRow = payload.new;
          // render if not already present (prevents duplicates)
          renderMessageRow(newRow);
        })
        .subscribe(status => {
          // console.log('subscription status', status);
        });
    }

    // ---------- Send logic (creates chat if needed) ----------
    sendButton.addEventListener('click', handleSend);
    messageInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
    });

    async function handleSend(){
      const text = messageInput.value.trim();
      if(!text) return;
      // if no chat open, create one
      if(!currentChatId){
        const chat = await createNewChat(text.slice(0,40) || 'New Chat');
        if(chat && chat.id) currentChatId = chat.id;
        await loadChatList();
        // proceed
      }
      // optimistic render
      const tempId = 'tm_' + Math.random().toString(36).slice(2,9);
      renderMessageRow({ id: tempId, role:'user', content:text });
      messageInput.value = '';
      // insert into DB
      try{
        const { error } = await supabase.from('messages').insert([{ chat_id: currentChatId, role: 'user', content: text }]);
        if(error) console.error('insert message error', error);
      } catch(e){ console.error(e); }

      // generate AI reply (mock) then save & render
      setTimeout(async ()=>{
        const ai = generateMockReply(text);
        // insert assistant message
        try{
          const { error } = await supabase.from('messages').insert([{ chat_id: currentChatId, role: 'assistant', content: ai }]);
          if(error) console.error('insert assistant error', error);
        } catch(e){ console.error(e); }
        // Note: the subscription will render the assistant message on INSERT.
      }, 700 + Math.random()*800);
    }

    // simple mock AI reply - replace with real API call if desired
    function generateMockReply(prompt){
      const snippets = [
        "Nice — here's a quick thought: " + prompt,
        "That's interesting. I think the important part is to focus on clarity and intent.",
        "Here's a short answer: try breaking this into smaller steps.",
        "I can help with that. Would you like an example or a short summary?",
        "Good question! Let's explore this further."
      ];
      return snippets[Math.floor(Math.random()*snippets.length)];
    }

    // ---------- UI actions ----------
    btnNewChat.addEventListener('click', async ()=>{
      await createNewChat('New Chat');
    });

    btnTheme.addEventListener('click', ()=>{
      document.body.classList.toggle('light');
      // small toggle effect - not full theme implementation
    });

    // ---------- init ----------
    (async function(){
      // basic safety: warn developer to set keys
      if(SUPABASE_URL.includes('REPLACE') || SUPABASE_ANON_KEY.includes('REPLACE')){
        console.warn('Please replace SUPABASE_URL and SUPABASE_ANON_KEY at the top of the file.');
      }
      // init UI
      showLogin();
      await initAuth();
    })();
  </script>
</body>
</html>
